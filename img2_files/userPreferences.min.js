"use strict";define("userPreferences",["lodash","jquery","util","coreUtilsLib"],function(e,t,r,n){function i(){function i(){return r.url.isTrue("fakeUserPrefs")}function u(e){var t=r.url.getParameterByName("resetUserPrefs").toLowerCase();return"all"===t||t===e}function f(t,r,n){return e.mapValues(t,function(t){return{value:e.isUndefined(n)?t:n,isDirty:r}})}function c(t){if(t.version===s)return f(t,!0);var r=e.assign({},e.omit(t,o,"version"),t[o]);return U(t),r=e.transform(r,function(e,t,r){e[_(o,r)]=t},{}),r.version=s,f(r,!0)}function d(e,t){switch(e){case j.global.id:return t.global_preferences;case j.site.id:return c(t);default:return n.log.error("unknown type ID"),{}}}function g(e,t){j.global.data={},k(j.global.id,e,t)}function p(e,t){j.site.data=f(j.site.data,!0,null),k(j.site.id,e,t)}function b(t){var r={nameSpace:"htmlEditor",siteId:I,data:{}};return e.forEach(t,function(e,t){e.isDirty&&(r.data[t]=e.value)}),r.data.version=s,r}function v(e){return{nameSpace:"htmlEditor",key:e,siteId:I}}function y(e){return{nameSpace:"htmlEditor",key:"global_preferences",blob:e}}function S(e){switch(e){case j.global.id:return y(j.global.data);case j.site.id:return b(j.site.data)}}function h(t){switch(t){case j.global.id:return{global_preferences:j.global.data};case j.site.id:var r={};return e.forEach(j.site.data,function(e,t){r[t]=e.value}),r.version=s,r;default:return n.log.error("unknown type ID"),{}}}function w(e,t,r,n){j[e].data=t?d(e,t):{},u(e)?D(e,r,n):r&&r()}function m(t){t===j.site.id&&e.forEach(j.site.data,function(e){e.isDirty=!1})}function E(e,r,n){if(i()){var a=window.sessionStorage.getItem("user_prefs_"+j[e].id);return void w(e,JSON.parse(a),r,n)}t.ajax(j[e].urls.getLoadUrl(),{type:"GET",success:function(t){w(e,t,r,n)},error:function(e){n&&n(e)}})}function U(t){e.forEach(t,function(e,t){x(t)})}function x(e){i()||t.ajax(j[j.site.id].urls.getDeleteUrl(),{type:"POST",contentType:"application/json; charset=utf-8",data:JSON.stringify(v(e))})}function D(e,t,r){switch(e){case j.global.id:return g(t,r);case j.site.id:return p(t,r)}}function k(e,r,n){if(null!==j[e].data){if(i()){var a=h(e);return window.sessionStorage.setItem("user_prefs_"+j[e].id,JSON.stringify(a)),m(e),void(r&&r())}if(!l){var o=S(e);o?t.ajax(j[e].urls.getSaveUrl(),{type:"POST",contentType:"application/json; charset=utf-8",data:JSON.stringify(o),success:function(){m(e),r&&r()},error:function(e){413===e.status&&(l=!0),n&&n(e)}}):r&&r()}}else n&&n("saving "+e+" preferences failed since they were not loaded")}function G(t,r){function i(e){if(function(){if(e&&e.responseText){var t=e.responseText.match(/errorCode="(\d+)"/);return"3001"===(t=t&&t[1])}return!1}())return j.global.data={},void t();j.global.data=null,n.log.error("Global preferences failed to load!"),r("Global preferences failed to load!")}t=t||e.noop,r=r||e.noop,E(j.global.id,t,i)}function P(t,r,i,a){var o=e.isEmpty(j.site.data);I=t;var s=k.bind(this,j.site.id,i,a);if(r)o||k(j.site.id,i,a);else if(o)E(j.site.id,s,function(){n.log.error("Site preferences failed to load!"),a&&a("Site preferences failed to load!")});else{var l=e.clone(j.site.data),u=function(){j.site.data=e.merge(j.site.data,l),s()};E(j.site.id,u,function(){n.log.error("Site preferences failed to load!"),s()})}}function _(e,t){return e+"_"+t}function T(t){return e.transform(j.site.data,function(e,r,n){var i=n.split("_");i[0]===t&&(e[i[1]]=r.value)},{})}var I=null,j={session:{id:"session",data:{}},site:{id:"site",data:{},urls:{getLoadUrl:function(){return a+"getVolatilePrefsForSite/htmlEditor/"+I},getSaveUrl:function(){return a+"bulkSet"},getDeleteUrl:function(){return a+"delete"}}},global:{id:"global",data:null,urls:{getLoadUrl:function(){return a+"getVolatilePrefForKey/htmlEditor/global_preferences"},getSaveUrl:function(){return a+"set"}}}};return{loadGlobalPreferences:G,loadSitePreferences:P,global:{get:function(t){if(null===j.global.data)return n.log.error("Global user preferences failed to load!"),null;if(!e.isString(t))throw new Error("Getting a global user preference expects a key of type string but received: "+t);return e.cloneDeep(j.global.data[t])},getAll:function(){return null===j.global.data?(n.log.error("Global user preferences failed to load!"),null):e.cloneDeep(j.global.data)},set:function(t,r,i,a){if(null===j.global.data)return n.log.error("Global user preferences failed to load!"),void(a&&a("Global user preferences failed to load!"));if(!e.isString(t))throw new Error("Setting a global user preference expects a key of type string but received: "+t);e.isUndefined(r)&&(r=null),j.global.data[t]=r,k(j.global.id,i,a)}},site:{get:function(t,r){if(r=r||o,!e.isString(t))throw new Error("Getting a user preference for the site expects a key of type string but received: "+t);var n=_(r,t);return e.cloneDeep(j.site.data[n]&&j.site.data[n].value)},getAll:function(){return T(o)},set:function(t,r,n,i,a){if(a=a||o,!e.isString(t))throw new Error("Setting a user preference for the site expects a key of type string but received: "+t);e.isUndefined(r)&&(r=null);var s={value:r,isDirty:!0};t=_(a,t),j.site.data[t]=s,I?k(j.site.id,n,i):n&&n()}},session:{get:function(t){if(!e.isString(t))throw new Error("Getting a session user preference expects a key of type string but received: "+t);return e.cloneDeep(j.session.data[t])},getAll:function(){return e.cloneDeep(j.session.data)},set:function(t,r,n){if(!e.isString(t))throw new Error("Setting a session user preference expects a key of type string but received: "+t);return j.session.data[t]=r,n&&n(),r}}}}var a=r.serviceTopology.premiumStateApiUrl;a=a?a.replace(/\/getTpaPremiumState/,"-user-preferences-webapp/"):"https://editor.wix.com/_api/wix-user-preferences-webapp/";var o="editorAppId",s=3,l=!1;return i});
//# sourceMappingURL=userPreferences.min.js.map